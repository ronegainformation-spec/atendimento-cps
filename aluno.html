<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minha Senha - CPS</title>
    <style>
        :root { --red: #b30000; --gold: #f1c40f; --bg: #0a0a0a; }
        
        body { 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            margin: 0; background: var(--bg); color: white; 
            text-align: center; display: flex; flex-direction: column; 
            min-height: 100vh; 
            overflow-x: hidden;
        }

        header { 
            background: var(--red); 
            padding: 12px; 
            border-bottom: 3px solid var(--gold); 
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            width: 100%;
        }

        .logo-aluno { height: 35px; filter: brightness(0) invert(1); }

        .status-top { 
            background: #1a1a1a; 
            color: var(--gold); 
            padding: 6px; 
            font-size: 0.65rem; 
            letter-spacing: 1.5px;
            font-weight: bold;
            width: 100%;
        }

        .main-content { 
            flex: 1; 
            padding: 20px 15px; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .label-chamando { color: #888; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; }

        /* Fonte responsiva: ajusta entre 5rem e 10rem dependendo da tela */
        .senha-atual { 
            font-size: clamp(5rem, 25vw, 10rem); 
            font-weight: 900; 
            color: var(--gold); 
            margin: 5px 0;
            text-shadow: 0 0 20px rgba(241, 196, 15, 0.2);
            line-height: 1;
        }

        .tipo-box {
            display: inline-block;
            padding: 8px 18px;
            border-radius: 50px;
            font-weight: bold;
            background: #222;
            color: #fff;
            margin-bottom: 30px;
            font-size: 0.85rem;
            border: 1px solid #333;
        }

        .history-container {
            background: #111;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            text-align: left;
            width: 100%;
            max-width: 500px; /* Evita que fique largo demais em tablets */
            margin: 0 auto;
        }

        .history-title {
            color: var(--red);
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 12px;
            border-bottom: 1px solid #222;
            padding-bottom: 8px;
            text-transform: uppercase;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #1a1a1a;
            color: #aaa;
        }

        .history-item strong { color: #eee; font-size: 1.1rem; }
        .history-item small { 
            background: #222; 
            padding: 2px 8px; 
            border-radius: 4px; 
            font-size: 0.7rem; 
        }

        footer { 
            background: #000; 
            padding: 15px; 
            font-size: 9px; 
            color: #444; 
            border-top: 1px solid #1a1a1a;
            width: 100%;
        }
        footer strong { color: var(--red); }

        /* BotÃ£o para garantir que o navegador permita vibraÃ§Ã£o e sons */
        #btn-vibrate {
            background: none;
            border: 1px solid #333;
            color: #666;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 0.7rem;
            margin-bottom: 15px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <header>
        <img src="logo-cps.png" class="logo-aluno" alt="CPS">
    </header>
    <div class="status-top">ATUALIZAÃ‡ÃƒO EM TEMPO REAL</div>

    <div class="main-content">
        <button id="btn-vibrate" onclick="ativarVibracao()">ðŸ”” ATIVAR NOTIFICAÃ‡Ã•ES</button>
        
        <div class="label-chamando">Chamando Agora</div>
        <div class="senha-atual" id="senha-display">--</div>
        <div class="tipo-box" id="tipo-display">Aguardando...</div>

        <div class="history-container">
            <div class="history-title">ÃšLTIMOS CHAMADOS</div>
            <div id="lista-historico">
                </div>
        </div>
    </div>

    <footer>
        TECNOLOGIA POR <strong>RONEGA INFORMATION SECURITY</strong>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAwpjh0QNhJEHowt-04PHUN_3-1XlrCgKg",
            authDomain: "sistemacps-743f3.firebaseapp.com",
            databaseURL: "https://sistemacps-743f3-default-rtdb.firebaseio.com",
            projectId: "sistemacps-743f3",
            storageBucket: "sistemacps-743f3.firebasestorage.app",
            messagingSenderId: "127411684616",
            appId: "1:127411684616:web:e3c9abb4d19287e5a818bd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let podeVibrar = false;
        let ultimoId = "";

        window.ativarVibracao = () => {
            podeVibrar = true;
            document.getElementById('btn-vibrate').innerText = "âœ… NOTIFICAÃ‡Ã•ES ATIVAS";
            document.getElementById('btn-vibrate').style.color = "#27ae60";
            if ("vibrate" in navigator) navigator.vibrate(100);
        };

        onValue(ref(db, 'chamada_ativa'), (snapshot) => {
            const info = snapshot.val();
            if (info) {
                document.getElementById('senha-display').innerText = info.senha;
                document.getElementById('tipo-display').innerText = 
                    info.tipo === 'P' ? 'ATENDIMENTO PRIORITÃRIO' : 'ATENDIMENTO NORMAL';
                
                // SÃ³ vibra se o ID da chamada mudar
                if (info.id && info.id !== ultimoId) {
                    if (podeVibrar && "vibrate" in navigator) {
                        navigator.vibrate([300, 100, 300]);
                    }
                    ultimoId = info.id;
                }
            }
        });

        onValue(ref(db, 'historico'), (snapshot) => {
            const lista = document.getElementById('lista-historico');
            lista.innerHTML = "";
            const data = snapshot.val();
            
            if (data) {
                const itens = Object.values(data).reverse().slice(1, 5);
                itens.forEach(item => {
                    if(item.senha) {
                        lista.innerHTML += `
                            <div class="history-item">
                                <span>Senha <strong>${item.senha}</strong></span>
                                <small>${item.tipo === 'P' ? 'Prioridade' : 'Normal'}</small>
                            </div>
                        `;
                    }
                });
            }
        });
    </script>
</body>
</html>