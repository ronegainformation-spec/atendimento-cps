<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta name="robots" content="noindex, nofollow">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Totem de Senhas - CPS</title>
    <style>
        :root { --red: #b30000; --gold: #f1c40f; }
        
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: #eef2f3; 
            margin: 0; 
            display: flex; 
            flex-direction: column;
            justify-content: center; 
            align-items: center; 
            min-height: 100vh;
            overflow: hidden; 
        }
        
        /* Link de Administração Atualizado para index.html */
        .btn-admin {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.05);
            color: #999;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            text-decoration: none;
            font-size: 0.7rem;
            font-weight: bold;
            z-index: 100;
        }
        .btn-admin:hover { background: rgba(0,0,0,0.1); color: #666; }

        /* Container Central Responsivo */
        .box { 
            background: white; 
            padding: 5vh 5vw; 
            border-radius: 30px; 
            text-align: center; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.1); 
            width: 85%; 
            max-width: 400px; 
            border-top: 10px solid var(--red);
            box-sizing: border-box;
        }

        .box img { 
            max-width: 150px; 
            width: 40%;
            margin-bottom: 2vh; 
        }
        
        h2 { 
            color: #333; 
            margin: 0 0 3vh 0; 
            font-weight: 400; 
            font-size: 1.4rem; 
        }
        
        button.gerar-btn { 
            width: 100%; 
            padding: 22px; 
            margin: 10px 0; 
            font-size: 1.4rem; 
            font-weight: 800; 
            border: none; 
            border-radius: 15px; 
            cursor: pointer; 
            color: white; 
            transition: 0.2s; 
            box-sizing: border-box;
        }

        .btn-n { background: var(--red); box-shadow: 0 6px 0 #800; }
        .btn-p { background: var(--gold); color: black; box-shadow: 0 6px 0 #b7950b; }
        
        button.gerar-btn:active { 
            transform: translateY(4px); 
            box-shadow: 0 2px 0 #333; 
        }
        
        #status { 
            margin-top: 20px; 
            font-weight: bold; 
            color: var(--red); 
            font-size: 1rem;
            height: 1.2em;
        }

        .totem-footer {
            margin-top: 20px;
            font-size: 0.65rem;
            color: #aaa;
            text-align: center;
        }

        /* TICKET DE IMPRESSÃO */
        #ticket { display: none; }
        @media print {
            .box, .btn-admin, .totem-footer { display: none !important; } 
            #ticket { 
                display: block !important; 
                width: 72mm; 
                text-align: center;
                font-family: monospace;
            }
            .senha-print { font-size: 60pt; font-weight: 900; }
        }

        @media (max-height: 600px) {
            .box { padding: 20px; }
            h2 { font-size: 1.1rem; margin-bottom: 10px; }
            button.gerar-btn { padding: 15px; font-size: 1.1rem; }
            .box img { max-width: 100px; }
        }
    </style>
</head>
<body>

<a href="index.html" class="btn-admin">ADM SISTEMA</a>

<div class="box">
    <img src="logo-cps.png" alt="Logo CPS">
    <h2>Toque para retirar sua senha:</h2>
    
    <button class="gerar-btn btn-n" onclick="gerar('N')">NORMAL</button>
    <button class="gerar-btn btn-p" onclick="gerar('P')">PRIORITÁRIO</button>
    
    <div id="status"></div>
</div>

<div class="totem-footer">
    DESENVOLVIDO POR RONEGA INFORMATION SECURITY
</div>

<div id="ticket">
    <div style="font-size: 12pt; font-weight: bold; border-bottom: 1px dashed #000; padding-bottom: 5mm; margin-bottom: 5mm;">
        CENTRO PAULA SOUZA<br>SISTEMA DE ATENDIMENTO
    </div>
    <div id="p-tipo" style="font-size: 14pt; font-weight: bold; border: 2px solid #000; padding: 2mm;">---</div>
    <span id="p-num" class="senha-print">---</span><br>
    <div id="p-data" style="font-size: 10pt; font-weight: bold;"></div>
    <div style="font-size: 8pt; margin-top: 5mm; border-top: 1px dashed #000; padding-top: 3mm;">
        Aguarde sua vez no painel.
    </div>
    <div style="font-size: 7pt; margin-top: 3mm; font-weight: bold;">
        Sistema por Ronega Information Security
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, runTransaction } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAwpjh0QNhJEHowt-04PHUN_3-1XlrCgKg",
        authDomain: "sistemacps-743f3.firebaseapp.com",
        databaseURL: "https://sistemacps-743f3-default-rtdb.firebaseio.com",
        projectId: "sistemacps-743f3",
        storageBucket: "sistemacps-743f3.firebasestorage.app",
        messagingSenderId: "127411684616",
        appId: "1:127411684616:web:e3c9abb4d19287e5a818bd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    window.gerar = (tipo) => {
        const statusMsg = document.getElementById('status');
        statusMsg.innerText = "⏳ Gerando...";

        runTransaction(ref(db, 'contadores/totem_' + tipo), (current) => {
            return (current || 0) + 1;
        }).then((result) => {
            if (result.committed) {
                const num = result.snapshot.val().toString().padStart(3, '0');
                const senhaGerada = tipo + num;

                document.getElementById('p-num').innerText = senhaGerada;
                document.getElementById('p-tipo').innerText = tipo === 'N' ? 'NORMAL' : 'PRIORITÁRIO';
                document.getElementById('p-data').innerText = new Date().toLocaleString('pt-BR');

                statusMsg.innerText = "✅ SENHA: " + senhaGerada;

                // Pequeno delay para o DOM atualizar antes de abrir a janela de impressão
                setTimeout(() => {
                    window.print();
                    statusMsg.innerText = "Retire seu ticket no totem.";
                    setTimeout(() => { statusMsg.innerText = ""; }, 4000);
                }, 400); 
            }
        }).catch((err) => {
            console.error(err);
            statusMsg.innerText = "❌ Erro ao conectar.";
        });
    };
</script>
</body>
</html>