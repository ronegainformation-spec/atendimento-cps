<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Totem de Senhas - CPS</title>
    <style>
        :root { --red: #b30000; --gold: #f1c40f; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #eef2f3; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; }
        
        /* Estilo do Totem na Tela */
        .box { background: white; padding: 50px; border-radius: 40px; text-align: center; box-shadow: 0 30px 60px rgba(0,0,0,0.15); width: 450px; border-top: 15px solid var(--red); }
        .box img { max-width: 220px; margin-bottom: 20px; }
        h2 { color: #333; margin-bottom: 30px; font-weight: 300; }
        
        button { width: 100%; padding: 30px; margin: 15px 0; font-size: 1.8rem; font-weight: 900; border: none; border-radius: 20px; cursor: pointer; color: white; transition: all 0.2s; position: relative; overflow: hidden; }
        .btn-n { background: var(--red); box-shadow: 0 10px 0 #800; }
        .btn-p { background: var(--gold); color: black; box-shadow: 0 10px 0 #b7950b; }
        button:active { transform: translateY(6px); box-shadow: 0 4px 0 #333; }
        
        #status { margin-top: 20px; font-weight: bold; color: #666; min-height: 1.2em; }

        /* ESTILO DO TICKET (O que sai na impressora) */
        #ticket { display: none; }

        @media print {
            body { background: white; }
            .box { display: none !important; } /* Esconde o totem na impressão */
            
            #ticket { 
                display: block !important; 
                width: 80mm; /* Largura padrão de bobina térmica */
                margin: 0 auto;
                text-align: center;
                padding: 10px;
                border: 1px solid #eee;
                color: black;
            }

            .header-print { font-size: 14pt; font-weight: bold; border-bottom: 2px dashed #000; padding-bottom: 10px; margin-bottom: 10px; }
            .senha-print { font-size: 70pt !important; font-weight: 900; margin: 20px 0; display: block; line-height: 1; }
            .tipo-print { font-size: 18pt; font-weight: bold; text-transform: uppercase; background: #000; color: #fff; padding: 5px; display: inline-block; width: 100%; }
            .footer-print { font-size: 10pt; margin-top: 20px; border-top: 1px dashed #000; padding-top: 10px; }
        }
    </style>
</head>
<body>

<div class="box">
    <img src="https://fatecead.com.br/wp-content/uploads/2021/01/logo-cps.png" alt="Logo CPS">
    <h2>Selecione o Atendimento</h2>
    
    <button class="btn-n" onclick="gerar('N')">NORMAL</button>
    <button class="btn-p" onclick="gerar('P')">PRIORITÁRIO</button>
    
    <div id="status"></div>
</div>

<div id="ticket">
    <div class="header-print">
        CENTRO PAULA SOUZA<br>
        SISTEMA DE ATENDIMENTO
    </div>
    
    <div id="p-tipo" class="tipo-print">---</div>
    
    <span id="p-num" class="senha-print">---</span>
    
    <div id="p-data" style="font-size: 12pt;"></div>
    
    <div class="footer-print">
        Por favor, aguarde ser chamado<br>através do painel eletrônico.
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, runTransaction } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAwpjh0QNhJEHowt-04PHUN_3-1XlrCgKg",
        authDomain: "sistemacps-743f3.firebaseapp.com",
        databaseURL: "https://sistemacps-743f3-default-rtdb.firebaseio.com",
        projectId: "sistemacps-743f3",
        storageBucket: "sistemacps-743f3.firebasestorage.app",
        messagingSenderId: "127411684616",
        appId: "1:127411684616:web:e3c9abb4d19287e5a818bd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    window.gerar = (tipo) => {
        const statusMsg = document.getElementById('status');
        statusMsg.innerText = "⏳ Processando...";

        const refTotem = ref(db, 'contadores/totem_' + tipo);
        
        runTransaction(refTotem, (current) => {
            return (current || 0) + 1;
        }).then((result) => {
            if (result.committed) {
                const num = result.snapshot.val().toString().padStart(3, '0');
                const senhaGerada = tipo + num;

                // INJETA OS DADOS NO TICKET DE IMPRESSÃO
                document.getElementById('p-num').innerText = senhaGerada;
                document.getElementById('p-tipo').innerText = tipo === 'N' ? 'NORMAL' : 'PRIORITÁRIO';
                document.getElementById('p-data').innerText = new Date().toLocaleString('pt-BR');

                statusMsg.innerText = "✅ Senha " + senhaGerada + " Gerada!";

                // FORÇA O NAVEGADOR A RECONHECER O TEXTO NOVO ANTES DE IMPRIMIR
                setTimeout(() => {
                    window.print();
                    statusMsg.innerText = "Retire seu ticket na impressora.";
                    
                    // Limpa mensagem após 3 segundos
                    setTimeout(() => { statusMsg.innerText = ""; }, 3000);
                }, 250); 
            }
        }).catch((err) => {
            console.error(err);
            statusMsg.innerText = "❌ Erro de conexão!";
        });
    };
</script>
</body>
</html>